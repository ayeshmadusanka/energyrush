{% extends "admin/base.html" %}

{% block page_title %}Orders Management{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="w-full mb-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Orders Management</h1>
            <p class="text-gray-600">Track and manage customer orders efficiently</p>
        </div>
    </div>
</section>

<!-- Simple Filter Section -->
<section class="w-full mb-8">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Status Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-energy-primary focus:border-transparent">
                    <option value="">All Status</option>
                    <option value="Pending">Pending</option>
                    <option value="Shipped">Shipped</option>
                    <option value="Delivered">Delivered</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
            </div>
            
            <!-- Date From -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                <input type="date" id="dateFrom" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-energy-primary focus:border-transparent">
            </div>
            
            <!-- Date To -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                <input type="date" id="dateTo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-energy-primary focus:border-transparent">
            </div>
            
            <!-- Search -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                <input type="text" id="searchBox" placeholder="Name, phone, or ID..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-energy-primary focus:border-transparent">
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="mt-4 flex gap-2">
            <button onclick="applyFilters()" class="px-6 py-2 bg-energy-primary text-white rounded-lg hover:bg-energy-secondary transition-colors">
                <i class="fas fa-filter mr-2"></i>Apply Filters
            </button>
            <button onclick="resetFilters()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                <i class="fas fa-undo mr-2"></i>Reset
            </button>
        </div>
    </div>
</section>

<!-- Stats Cards -->
<div id="statsSection" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-xl p-6 shadow-lg border-l-4 border-energy-primary">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-600">Total Orders</p>
                <p id="statTotal" class="text-2xl font-bold text-gray-900">{{ orders.total }}</p>
            </div>
            <i class="fas fa-shopping-cart text-3xl text-energy-primary"></i>
        </div>
    </div>
    
    <div class="bg-white rounded-xl p-6 shadow-lg border-l-4 border-yellow-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-600">Pending</p>
                <p id="statPending" class="text-2xl font-bold text-gray-900">{{ orders.stats.pending }}</p>
            </div>
            <i class="fas fa-clock text-3xl text-yellow-500"></i>
        </div>
    </div>
    
    <div class="bg-white rounded-xl p-6 shadow-lg border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-600">Shipped</p>
                <p id="statShipped" class="text-2xl font-bold text-gray-900">{{ orders.stats.shipped }}</p>
            </div>
            <i class="fas fa-truck text-3xl text-blue-500"></i>
        </div>
    </div>
    
    <div class="bg-white rounded-xl p-6 shadow-lg border-l-4 border-green-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-600">Delivered</p>
                <p id="statDelivered" class="text-2xl font-bold text-gray-900">{{ orders.stats.delivered }}</p>
            </div>
            <i class="fas fa-check-circle text-3xl text-green-500"></i>
        </div>
    </div>
</div>

<!-- Orders Table -->
<div class="bg-white rounded-2xl shadow-lg overflow-hidden">
    <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-white border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">
            <i class="fas fa-list text-energy-primary mr-2"></i>
            <span id="tableTitle">All Orders ({{ orders.total }})</span>
        </h2>
    </div>
    
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden p-8 text-center">
        <div class="inline-flex items-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-energy-primary mr-3"></div>
            <span class="text-gray-600">Loading orders...</span>
        </div>
    </div>
    
    <!-- Table Container -->
    <div id="ordersContainer">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Order ID</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Customer</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Items</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Total</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Date</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody" class="divide-y divide-gray-200">
                    {% for order in orders.items %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm font-bold text-energy-primary">#{{ order.id }}</span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-energy-primary rounded-full flex items-center justify-center mr-3">
                                    <span class="text-sm font-bold text-white">{{ order.customer_name[0].upper() if order.customer_name else 'U' }}</span>
                                </div>
                                <div>
                                    <div class="text-sm font-bold text-gray-900">{{ order.customer_name }}</div>
                                    <div class="text-xs text-gray-500">{{ order.customer_phone }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            {% if order.items %}
                                {% set items = order.items|from_json %}
                                <div class="text-sm text-gray-600">
                                    {% for item in items[:2] %}
                                        <div><span class="font-semibold">{{ item.quantity }}x</span> {{ item.name }}</div>
                                    {% endfor %}
                                    {% if items|length > 2 %}
                                        <div class="text-xs text-gray-500">+{{ items|length - 2 }} more</div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <span class="text-sm text-gray-500">No items</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-lg font-bold text-green-600">${{ "%.2f"|format(order.total_amount) }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% set status_colors = {
                                'Pending': 'bg-yellow-100 text-yellow-800',
                                'Shipped': 'bg-blue-100 text-blue-800',
                                'Delivered': 'bg-green-100 text-green-800',
                                'Cancelled': 'bg-red-100 text-red-800'
                            } %}
                            <span class="px-3 py-1 text-xs font-semibold rounded-full {{ status_colors.get(order.status, 'bg-gray-100 text-gray-800') }}">
                                {{ order.status }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">{{ order.created_at.strftime('%Y-%m-%d') }}</div>
                            <div class="text-xs text-gray-500">{{ order.created_at.strftime('%H:%M') }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center space-x-2">
                                <button onclick="viewOrder({{ order.id }})" class="text-blue-600 hover:text-blue-900">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if order.status not in ['Delivered', 'Cancelled'] %}
                                <button onclick="showStatusMenu({{ order.id }})" class="text-green-600 hover:text-green-900">
                                    <i class="fas fa-edit"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- No Results Message -->
    <div id="noResults" class="hidden p-12 text-center">
        <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-600 mb-2">No orders found</h3>
        <p class="text-gray-500">Try adjusting your filters</p>
    </div>
    
    <!-- Pagination -->
    {% if orders.pages > 1 %}
    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
        <div class="flex items-center justify-between">
            <!-- Results info -->
            <div class="text-sm text-gray-600">
                Showing {{ (orders.page - 1) * orders.per_page + 1 }} to 
                {{ orders.page * orders.per_page if orders.page < orders.pages else orders.total }} 
                of {{ orders.total }} results
            </div>
            
            <!-- Pagination buttons -->
            <div class="flex items-center space-x-2">
                <!-- Previous button -->
                {% if orders.has_prev %}
                    <a href="{{ url_for('admin_orders', page=orders.prev_num) }}" 
                       class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700 transition-colors">
                        <i class="fas fa-chevron-left mr-1"></i>Previous
                    </a>
                {% else %}
                    <span class="px-3 py-2 text-sm font-medium text-gray-300 bg-gray-100 border border-gray-300 rounded-md cursor-not-allowed">
                        <i class="fas fa-chevron-left mr-1"></i>Previous
                    </span>
                {% endif %}
                
                <!-- Page numbers -->
                <div class="hidden sm:flex space-x-1">
                    {% for page_num in orders.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                        {% if page_num %}
                            {% if page_num != orders.page %}
                                <a href="{{ url_for('admin_orders', page=page_num) }}" 
                                   class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700 transition-colors">
                                    {{ page_num }}
                                </a>
                            {% else %}
                                <span class="px-3 py-2 text-sm font-medium text-white bg-energy-primary border border-energy-primary rounded-md">
                                    {{ page_num }}
                                </span>
                            {% endif %}
                        {% else %}
                            <span class="px-3 py-2 text-sm font-medium text-gray-300">…</span>
                        {% endif %}
                    {% endfor %}
                </div>
                
                <!-- Mobile page info -->
                <div class="sm:hidden">
                    <span class="px-3 py-2 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded-md">
                        {{ orders.page }} / {{ orders.pages }}
                    </span>
                </div>
                
                <!-- Next button -->
                {% if orders.has_next %}
                    <a href="{{ url_for('admin_orders', page=orders.next_num) }}" 
                       class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700 transition-colors">
                        Next<i class="fas fa-chevron-right ml-1"></i>
                    </a>
                {% else %}
                    <span class="px-3 py-2 text-sm font-medium text-gray-300 bg-gray-100 border border-gray-300 rounded-md cursor-not-allowed">
                        Next<i class="fas fa-chevron-right ml-1"></i>
                    </span>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Status Update Modal -->
<div id="statusModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-96">
        <h3 class="text-lg font-bold mb-4">Update Order Status</h3>
        <input type="hidden" id="updateOrderId">
        <div class="space-y-2">
            <button onclick="updateStatus('Pending')" class="w-full text-left px-4 py-2 hover:bg-yellow-50 rounded">
                <i class="fas fa-clock text-yellow-500 mr-2"></i>Mark as Pending
            </button>
            <button onclick="updateStatus('Shipped')" class="w-full text-left px-4 py-2 hover:bg-blue-50 rounded">
                <i class="fas fa-truck text-blue-500 mr-2"></i>Mark as Shipped
            </button>
            <button onclick="updateStatus('Delivered')" class="w-full text-left px-4 py-2 hover:bg-green-50 rounded">
                <i class="fas fa-check-circle text-green-500 mr-2"></i>Mark as Delivered
            </button>
            <button onclick="updateStatus('Cancelled')" class="w-full text-left px-4 py-2 hover:bg-red-50 rounded">
                <i class="fas fa-times-circle text-red-500 mr-2"></i>Cancel Order
            </button>
        </div>
        <button onclick="closeStatusModal()" class="mt-4 w-full px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
            Close
        </button>
    </div>
</div>

<script>
// Simple and optimized filtering system
let allOrders = [];
let filteredOrders = [];

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Store all orders from initial load
    storeInitialOrders();
    
    // Add event listeners for real-time filtering
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('dateFrom').addEventListener('change', applyFilters);
    document.getElementById('dateTo').addEventListener('change', applyFilters);
    document.getElementById('searchBox').addEventListener('input', debounce(applyFilters, 300));
});

// Store initial orders data
function storeInitialOrders() {
    // We'll fetch this from the server
    fetchOrders();
}

// Fetch orders from server
async function fetchOrders() {
    try {
        const response = await fetch('/admin/orders/filter', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                status: '',
                date_from: '',
                date_to: '',
                search: ''
            })
        });
        
        const data = await response.json();
        if (data.success) {
            allOrders = data.orders;
            filteredOrders = allOrders;
            renderOrders(filteredOrders);
            updateStats(data.stats);
        }
    } catch (error) {
        console.error('Error fetching orders:', error);
    }
}

// Apply filters
async function applyFilters() {
    const status = document.getElementById('statusFilter').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const search = document.getElementById('searchBox').value.toLowerCase();
    
    showLoading(true);
    
    try {
        const response = await fetch('/admin/orders/filter', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                status: status,
                date_from: dateFrom,
                date_to: dateTo,
                search: search
            })
        });
        
        const data = await response.json();
        if (data.success) {
            filteredOrders = data.orders;
            renderOrders(filteredOrders);
            updateStats(data.stats);
        }
    } catch (error) {
        console.error('Error applying filters:', error);
    } finally {
        showLoading(false);
    }
}

// Reset all filters
function resetFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    document.getElementById('searchBox').value = '';
    applyFilters();
}

// Render orders in table
function renderOrders(orders) {
    const tbody = document.getElementById('ordersTableBody');
    const noResults = document.getElementById('noResults');
    const container = document.getElementById('ordersContainer');
    
    if (orders.length === 0) {
        container.style.display = 'none';
        noResults.classList.remove('hidden');
        document.getElementById('tableTitle').textContent = 'No Orders Found';
        return;
    }
    
    container.style.display = 'block';
    noResults.classList.add('hidden');
    document.getElementById('tableTitle').textContent = `Orders (${orders.length})`;
    
    tbody.innerHTML = orders.map(order => `
        <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="text-sm font-bold text-energy-primary">#${order.id}</span>
            </td>
            <td class="px-6 py-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-energy-primary rounded-full flex items-center justify-center mr-3">
                        <span class="text-sm font-bold text-white">${order.customer_initial}</span>
                    </div>
                    <div>
                        <div class="text-sm font-bold text-gray-900">${order.customer_name}</div>
                        <div class="text-xs text-gray-500">${order.customer_phone}</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4">
                ${renderItems(order.items)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="text-lg font-bold text-green-600">$${order.total_amount.toFixed(2)}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                ${renderStatusBadge(order.status)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${order.created_date}</div>
                <div class="text-xs text-gray-500">${order.created_time}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center space-x-2">
                    <button onclick="viewOrder(${order.id})" class="text-blue-600 hover:text-blue-900">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${order.status !== 'Delivered' && order.status !== 'Cancelled' ? `
                        <button onclick="showStatusMenu(${order.id})" class="text-green-600 hover:text-green-900">
                            <i class="fas fa-edit"></i>
                        </button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `).join('');
}

// Render order items
function renderItems(items) {
    if (!items || items.length === 0) {
        return '<span class="text-sm text-gray-500">No items</span>';
    }
    
    let html = '<div class="text-sm text-gray-600">';
    const displayItems = items.filter(item => !item.more_count);
    
    displayItems.forEach(item => {
        html += `<div><span class="font-semibold">${item.quantity}x</span> ${item.name}</div>`;
    });
    
    const moreItem = items.find(item => item.more_count);
    if (moreItem) {
        html += `<div class="text-xs text-gray-500">+${moreItem.more_count} more</div>`;
    }
    
    return html + '</div>';
}

// Render status badge
function renderStatusBadge(status) {
    const colors = {
        'Pending': 'bg-yellow-100 text-yellow-800',
        'Shipped': 'bg-blue-100 text-blue-800',
        'Delivered': 'bg-green-100 text-green-800',
        'Cancelled': 'bg-red-100 text-red-800'
    };
    
    return `<span class="px-3 py-1 text-xs font-semibold rounded-full ${colors[status] || 'bg-gray-100 text-gray-800'}">
        ${status}
    </span>`;
}

// Update statistics
function updateStats(stats) {
    if (stats) {
        document.getElementById('statTotal').textContent = stats.total || 0;
        document.getElementById('statPending').textContent = stats.pending || 0;
        document.getElementById('statShipped').textContent = stats.shipped || 0;
        document.getElementById('statDelivered').textContent = stats.delivered || 0;
    }
}

// Show/hide loading
function showLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    const container = document.getElementById('ordersContainer');
    
    if (show) {
        spinner.classList.remove('hidden');
        container.style.opacity = '0.5';
    } else {
        spinner.classList.add('hidden');
        container.style.opacity = '1';
    }
}

// Debounce function for search
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// View order details
function viewOrder(orderId) {
    // Implement order details view
    window.location.href = `/admin/orders/${orderId}`;
}

// Show status update modal
function showStatusMenu(orderId) {
    document.getElementById('updateOrderId').value = orderId;
    document.getElementById('statusModal').classList.remove('hidden');
}

// Close status modal
function closeStatusModal() {
    document.getElementById('statusModal').classList.add('hidden');
}

// Update order status
async function updateStatus(newStatus) {
    const orderId = document.getElementById('updateOrderId').value;
    
    try {
        const response = await fetch(`/admin/orders/update_status/${orderId}?status=${newStatus}`);
        if (response.ok) {
            closeStatusModal();
            applyFilters(); // Refresh the list
        }
    } catch (error) {
        console.error('Error updating status:', error);
    }
}
</script>
{% endblock %}